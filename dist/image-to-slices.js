/*
 * image-to-slices 0.1.0
 * Node.js module for converting image into slices with the given reference lines.
 * https://github.com/superRaytin/image-to-slices
 *
 * Copyright 2015, Leon Shi
 * Released under the MIT license.
*/

!function t(e,n,i){function r(a,s){if(!n[a]){if(!e[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);throw new Error("Cannot find module '"+a+"'")}var f=n[a]={exports:{}};e[a][0].call(f.exports,function(t){var n=e[a][1][t];return r(n?n:t)},f,f.exports,t,e,n,i)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(t,e,n){"use strict";function i(t,e,n,i,a){r.apply(null,arguments),"function"==typeof i&&(a=i,i={});var s;return s=i?new o(e,n,i):new o(e,n),s.slice(t,a)}function r(t,e,n){if("String"!==a.type(t)||"Array"!==a.type(e)||"Array"!==a.type(n))throw new Error("Invalid arguments.")}var o=t("./image-to-slices"),a=t("./utils");i.configure=function(t,e){o.__configure(t,e)},e.exports=i,"function"==typeof define&&define.amd?define(function(){return i}):("undefined"!=typeof window||"undefined"!=typeof navigator)&&(window.imageToSlices=i)},{"./image-to-slices":2,"./utils":3}],2:[function(t,e,n){function i(t,e,n){if(n=n||{},this.lineXArray=s.sortAndUnique(t)||[],this.lineYArray=s.sortAndUnique(e)||[],this.options={},s.extend(this.options,this.defaults,n),!this.lineXArray.length&&!this.lineYArray.length)throw new Error("At least one reference line");if(!this.options.saveToDir&&!this.options.saveToDataUrl)throw new Error("Either saveToDir or saveToDataUrl must be specified");if(u&&this.options.saveToDir&&!this.options.saveToDataUrl)throw new Error("Does not support saving as file in the Browser, use saveToDataUrl instead");return this}var r=t("path"),o=t("image-clipper"),a=t("slices"),s=t("./utils"),u=s.isBrowser();i.prototype.defaults={saveToDir:null,saveToDataUrl:!1,clipperOptions:null,middleBoundaryMode:!1},i.prototype.clipChild=function(t,e,n){function i(){var t=o.shift(),p=a,h="section-"+e+"-"+p+"."+s,d=r.join(u,h);return a++,t?(l.reset().crop(t.x,t.y,t.width,t.height),void(f?l.toDataURL(function(t){c[e-1].children[p-1].dataURI=t,i()}):l.toFile(d,function(){i()}))):void n()}var o=t.slice(),a=1,s=this.imageFormat,u=this.options.saveToDir||"",f=this.options.saveToDataUrl,l=this.clipper,c=this.dataUrlList;i()},i.prototype.clip=function(t,e){function n(){var l=t.shift(),p=c,h="section-"+p+"."+u,d=r.join(a,h);if(c++,!l)return void(e&&(s?e(i):e()));if(l.children){var g=l.boundary.leftTop.x+20,y=l.boundary.leftTop.y,m=l.boundary.rightBottom.x-l.boundary.leftTop.x-40,v=l.boundary.rightBottom.y-l.boundary.leftTop.y;f.reset().clear(g,y,m,v).crop(l.x,l.y,l.width,l.height),s?f.toDataURL(function(t){i[p-1].dataURI=t,o.clipChild(l.children,p,n)}):f.toFile(d,function(){o.clipChild(l.children,p,n)})}else f.reset().crop(l.x,l.y,l.width,l.height),s?f.toDataURL(function(t){i[p-1].dataURI=t,n()}):f.toFile(d,function(){n()})}var i,o=this,a=this.options.saveToDir||"",s=this.options.saveToDataUrl,u=this.imageFormat,f=this.clipper,l=t.slice();if(s&&(i=this.dataUrlList||(this.dataUrlList=l)),t.length){var c=1;n()}},i.prototype.slice=function(t,e){var n=this,i=this.options,r=this.lineXArray,u=this.lineYArray;this.imageFormat=s.getFileFormat(t),i.clipperOptions&&i.clipperOptions.canvas&&o.configure("canvas",i.clipperOptions.canvas),o(t,function(){n.clipper=this,i.clipperOptions&&this.configure(i.clipperOptions);var t=this.canvas.width,o=this.canvas.height;r.push(o),u.push(t),n.lineXArray=s.sortAndUnique(r),n.lineYArray=s.sortAndUnique(u);var f=a(t,o,n.lineXArray,n.lineYArray,{middleBoundaryMode:i.middleBoundaryMode});n.clip(f,e)})},i.__configure=function(t,e){var n=i.prototype.defaults;s.setter(n,t,e)},e.exports=i},{"./utils":3,"image-clipper":8,path:5,slices:11}],3:[function(t,e,n){(function(t,n){"use strict";var i={};i.isBrowser=function(){var t=i.isElectron(),e=i.isNW();return!t&&!e&&!("undefined"==typeof window||"undefined"==typeof navigator)},i.isNode=function(){return!("undefined"==typeof t||!t.platform||!t.versions)},i.isNW=function(){var e=i.isNode();return e&&!("undefined"==typeof n||!t.__node_webkit||!t.versions["node-webkit"])},i.isElectron=function(){var e=i.isNode();return e&&!("undefined"==typeof n||!t.versions.electron)},i.type=function(t){return Object.prototype.toString.call(t).split(" ")[1].replace("]","")},i.each=function(t,e){var n=t.length;if(n)for(var i=0;n>i&&e.call(t[i],t[i],i)!==!1;i++);else if("undefined"==typeof n)for(var r in t)if(e.call(t[r],t[r],r)===!1)break},i.extend=function(t){i.each(arguments,function(e,n){n>0&&i.each(e,function(e,n){"undefined"!=typeof e&&(t[n]=e)})})},i.setter=function(t,e,n){var r=i.type(e);if("String"===r){if("undefined"==typeof t[e])throw new Error("Invalid configuration name.");if("undefined"==typeof n)throw new Error("Lack of a value corresponding to the name");"Object"===i.type(n)&&"Object"===i.type(t[e])?i.extend(t[e],n):t[e]=n}else{if("Object"!==r)throw new Error("Invalid arguments");n=e,i.extend(t,n)}},i.getFileFormat=function(t){var e=t.substr(t.lastIndexOf(".")+1,t.length);return e},i.sortAndUnique=function(t){var e=[],n={};return i.each(t,function(t){n[t]||(e.push(t),n[t]=!0)}),e.sort(function(t,e){return t-e>0})},e.exports=i}).call(this,t("1YiZ5S"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"1YiZ5S":6}],4:[function(t,e,n){},{}],5:[function(t,e,n){(function(t){function e(t,e){for(var n=0,i=t.length-1;i>=0;i--){var r=t[i];"."===r?t.splice(i,1):".."===r?(t.splice(i,1),n++):n&&(t.splice(i,1),n--)}if(e)for(;n--;n)t.unshift("..");return t}function i(t,e){if(t.filter)return t.filter(e);for(var n=[],i=0;i<t.length;i++)e(t[i],i,t)&&n.push(t[i]);return n}var r=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,o=function(t){return r.exec(t).slice(1)};n.resolve=function(){for(var n="",r=!1,o=arguments.length-1;o>=-1&&!r;o--){var a=o>=0?arguments[o]:t.cwd();if("string"!=typeof a)throw new TypeError("Arguments to path.resolve must be strings");a&&(n=a+"/"+n,r="/"===a.charAt(0))}return n=e(i(n.split("/"),function(t){return!!t}),!r).join("/"),(r?"/":"")+n||"."},n.normalize=function(t){var r=n.isAbsolute(t),o="/"===a(t,-1);return t=e(i(t.split("/"),function(t){return!!t}),!r).join("/"),t||r||(t="."),t&&o&&(t+="/"),(r?"/":"")+t},n.isAbsolute=function(t){return"/"===t.charAt(0)},n.join=function(){var t=Array.prototype.slice.call(arguments,0);return n.normalize(i(t,function(t,e){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t}).join("/"))},n.relative=function(t,e){function i(t){for(var e=0;e<t.length&&""===t[e];e++);for(var n=t.length-1;n>=0&&""===t[n];n--);return e>n?[]:t.slice(e,n-e+1)}t=n.resolve(t).substr(1),e=n.resolve(e).substr(1);for(var r=i(t.split("/")),o=i(e.split("/")),a=Math.min(r.length,o.length),s=a,u=0;a>u;u++)if(r[u]!==o[u]){s=u;break}for(var f=[],u=s;u<r.length;u++)f.push("..");return f=f.concat(o.slice(s)),f.join("/")},n.sep="/",n.delimiter=":",n.dirname=function(t){var e=o(t),n=e[0],i=e[1];return n||i?(i&&(i=i.substr(0,i.length-1)),n+i):"."},n.basename=function(t,e){var n=o(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},n.extname=function(t){return o(t)[3]};var a="b"==="ab".substr(-1)?function(t,e,n){return t.substr(e,n)}:function(t,e,n){return 0>e&&(e=t.length+e),t.substr(e,n)}}).call(this,t("1YiZ5S"))},{"1YiZ5S":6}],6:[function(t,e,n){function i(){}var r=e.exports={};r.nextTick=function(){var t="undefined"!=typeof window&&window.setImmediate,e="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(t)return function(t){return window.setImmediate(t)};if(e){var n=[];return window.addEventListener("message",function(t){var e=t.source;if((e===window||null===e)&&"process-tick"===t.data&&(t.stopPropagation(),n.length>0)){var i=n.shift();i()}},!0),function(t){n.push(t),window.postMessage("process-tick","*")}}return function(t){setTimeout(t,0)}}(),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.on=i,r.addListener=i,r.once=i,r.off=i,r.removeListener=i,r.removeAllListeners=i,r.emit=i,r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")}},{}],7:[function(t,e,n){(function(n){"use strict";function i(t){return t=t||{},this.options={},r.extend(this.options,this.defaults,t),this.quality(this.options.quality),this}var r=t("./utils"),o=t("./polyfills"),a=r.isElectron(),s=r.isNW(),u=r.isBrowser(),f=u||a||s;i.prototype.defaults={canvas:null,quality:92,maxQuality:100,minQuality:1,bufsize:4096},i.prototype.loadImageFromMemory=function(t){var e=this.options;t=t||this.originalImage;var n=t.width,i=t.height,o=this.__createCanvas(n,i),a=o.getContext("2d");return a.drawImage(t,0,0,n,i),this.canvas=o,e.imageFormat=e.imageFormat||r.getImageFormat(t.src),this.originalImage||(this.originalImage=t),this},i.prototype.loadImageFromUrl=function(t,e){var n=this,i=this.options,o=this.__createImage();i.imageFormat=i.imageFormat||r.getImageFormat(t),o.onload=function(){n.loadImageFromMemory(o),e.call(n)},o.src=t},i.prototype.image=function(t,e){var n=this.options,i=r.type(t);if("String"!==i&&"Image"!==i&&"HTMLImageElement"!==i)throw new Error("invalid arguments");if("String"===i){if(!e)throw new Error("callback must be specified when load from path");n.imageFormat=n.imageFormat||r.getImageFormat(t),this.loadImageFromUrl(t,function(){e.call(this)})}else if("Image"===i||"HTMLImageElement"===i)return n.imageFormat=n.imageFormat||r.getImageFormat(t.src),this.loadImageFromMemory(t),e&&"Function"===r.type(e)&&(e.call(this),console.warn("No need to specify callback when load from memory, please use chain-capable method directly like this: clipper(Image).crop(...).resize(...)")),this},i.prototype.crop=function(t,e,n,i){var r=this.canvas,o=r.getContext("2d"),a=o.getImageData(t,e,n,i),s=this.__createCanvas(n,i),u=s.getContext("2d");return u.rect(0,0,n,i),u.fillStyle="white",u.fill(),u.putImageData(a,0,0),this.canvas=s,this},i.prototype.toFile=function(t,e){var n=this,i=this.options,r=i.imageFormat;return this.toDataURL(function(i){u?e.call(n,i):this.dataUrlToFile(t,i,r,function(){e.call(n)})}),this},i.prototype.dataUrlToFile=function(t,e,i,r){var a=this,s=e.replace("data:"+i+";base64,",""),u=new n(s,"base64");o.writeFile(t,u,function(){r.call(a)})},i.prototype.resize=function(t,e){var n,i,r=this.canvas;if(!arguments.length)throw new Error("resize() must be specified at least one parameter");if(1===arguments.length){if(!t)throw new Error("resize() inappropriate parameter");n=t/r.width,e=r.height*n}else!t&&e&&(i=e/r.height,t=r.width*i);var o=this.__createCanvas(t,e),a=o.getContext("2d");return a.drawImage(r,0,0,t,e),this.canvas=o,this},i.prototype.clear=function(t,e,n,i){var r=this.canvas,o=r.getContext("2d");return o.clearRect(t,e,n,i),o.fillStyle="#fff",o.fillRect(t,e,n,i),this},i.prototype.quality=function(t){if("Number"!==r.type(t)&&"String"!==r.type(t))throw new Error("Invalid arguments");if(!t)return this;var e=this.options;return t=parseFloat(t),t=r.rangeNumber(t,e.minQuality,e.maxQuality),e.quality=t,this},i.prototype.toDataURL=function(t,e){var n=this,i=this.options,a=i.quality,s=i.minQuality,u=i.maxQuality,l=i.imageFormat,c=i.bufsize;"string"==typeof t&&(t=parseFloat(t)),0===arguments.length?t=a:1===arguments.length?"number"==typeof t?t=r.rangeNumber(t,s,u):"function"==typeof t&&(e=t,t=a):2===arguments.length&&(t=r.rangeNumber(t,s,u));var p=this.canvas;if(f){var h=p.toDataURL(l,t/100);return e&&e.call(this,h),h}if(!e)throw new Error("toDataURL(): callback must be specified");return o.toDataURL({canvas:p,imageFormat:l,quality:t,bufsize:c},function(t){e.call(n,t)}),this},i.prototype.configure=function(t,e){var n=this.options;return r.setter(n,t,e),n.quality&&this.quality(n.quality),this},i.prototype.getCanvas=function(){return this.canvas},i.prototype.destroy=function(){return this.canvas=null,this},i.prototype.reset=function(){return this.destroy().loadImageFromMemory()},i.prototype.injectNodeCanvas=function(t){"undefined"!=typeof t&&(this.options.canvas=t)},i.prototype.__createCanvas=function(t,e){var n,i;if(f){var r=window.document;i=r.createElement("canvas"),i.width=t,i.height=e}else{if(n=this.options.canvas,!n||!n.Image)throw new Error("Require node-canvas on the server-side Node.js");i=new n(t,e)}return i},i.prototype.__createImage=function(){var t,e,n;if(f)t=window.Image;else{if(n=this.options.canvas,!n||!n.Image)throw new Error("Require node-canvas on the server-side Node.js");t=n.Image}return e=new t},i.__configure=function(t,e){var n=i.prototype.defaults;r.setter(n,t,e),n.quality&&(n.quality=r.rangeNumber(n.quality,n.minQuality,n.maxQuality))},e.exports=i}).call(this,t("buffer").Buffer)},{"./polyfills":9,"./utils":10,buffer:4}],8:[function(t,e,n){"use strict";function i(t,e,n){var i;switch(arguments.length){case 0:i=new r;break;case 1:"Object"===o.type(t)?i=new r(t):(i=new r,i.image(t));break;case 2:n=e,e=null,i=new r,i.image(t,function(){n.call(this)});break;default:if("Object"!==o.type(e))throw new Error("invalid arguments");i=new r(e),i.image(t,function(){n.call(this)})}return i}var r=t("./clipper"),o=t("./utils");i.configure=function(t,e){r.__configure(t,e)},n=e.exports=i,n.imageClipper=i,"function"==typeof define&&define.amd?define(function(){return i}):("undefined"!=typeof window||"undefined"!=typeof navigator)&&(window.imageClipper=i)},{"./clipper":7,"./utils":10}],9:[function(t,e,n){"use strict";var i=t("fs"),r={};r.writeFile=function(t,e,n){i.writeFile(t,e,function(t){if(t)throw t;n()})},r.toDataURL=function(t,e){var n=t.canvas,i=t.imageFormat,r=t.quality,o=t.bufsize;"image/jpeg"===i?n.toDataURL(i,{quality:r,bufsize:o},function(t,n){if(t)throw t;e(n)}):n.toDataURL(i,function(t,n){if(t)throw t;e(n)})},e.exports=r},{fs:4}],10:[function(t,e,n){(function(t,n){"use strict";var i={};i.isBrowser=function(){var t=i.isElectron(),e=i.isNW();return!t&&!e&&!("undefined"==typeof window||"undefined"==typeof navigator)},i.isNode=function(){return!("undefined"==typeof t||!t.platform||!t.versions)},i.isNW=function(){var e=i.isNode();return e&&!("undefined"==typeof n||!t.__node_webkit||!t.versions["node-webkit"])},i.isElectron=function(){var e=i.isNode();return e&&!("undefined"==typeof n||!t.versions.electron)},i.type=function(t){return Object.prototype.toString.call(t).split(" ")[1].replace("]","")},i.rangeNumber=function(t,e,n){return t>n?n:e>t?e:t},i.each=function(t,e){var n=t.length;if(n)for(var i=0;n>i&&e.call(t[i],t[i],i)!==!1;i++);else if("undefined"==typeof n)for(var r in t)if(e.call(t[r],t[r],r)===!1)break},i.extend=function(t){i.each(arguments,function(e,n){n>0&&i.each(e,function(e,n){"undefined"!=typeof e&&(t[n]=e)})})},i.setter=function(t,e,n){var r=i.type(e);if("String"===r){if("undefined"==typeof t[e])throw new Error("Invalid configuration name.");if("undefined"==typeof n)throw new Error("Lack of a value corresponding to the name");"Object"===i.type(n)&&"Object"===i.type(t[e])?i.extend(t[e],n):t[e]=n}else{if("Object"!==r)throw new Error("Invalid arguments");n=e,i.extend(t,n)}},i.getImageFormat=function(t){var e=t.substr(t.lastIndexOf(".")+1,t.length);return e="jpg"===e?"jpeg":e,"image/"+e},i.upperCaseFirstLetter=function(t){return t.replace(t.charAt(0),function(t){return t.toUpperCase()})},e.exports=i}).call(this,t("1YiZ5S"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"1YiZ5S":6}],11:[function(t,e,n){"use strict";function i(t,e,n,i,a){r.apply(null,arguments);var s;return s=a?new o(t,e,n,i,a):new o(t,e,n,i),s.slice()}function r(t,e,n,i,r){if("Number"!==a.type(t)||"Number"!==a.type(e)||"Array"!==a.type(n)||"Array"!==a.type(i)||r&&"Object"!==a.type(r))throw new Error("Invalid arguments.")}var o=t("./slices"),a=t("./utils");n=e.exports=i,n.Slices=i,"function"==typeof define&&define.amd?define(function(){return i}):("undefined"!=typeof window||"undefined"!=typeof navigator)&&(window.Slices=i)},{"./slices":12,"./utils":13}],12:[function(t,e,n){"use strict";function i(t,e,n,i,o){if(o=o||{},this.width=t,this.height=e,n=n||[],i=i||[],n.push(e),i.push(t),this.lineXArray=r.sortAndUnique(n),this.lineYArray=r.sortAndUnique(i),this.options={},r.extend(this.options,this.defaults,o),!this.lineXArray.length&&!this.lineYArray.length)throw new Error("At least one reference line");return this}var r=t("./utils");i.prototype.defaults={middleBoundaryMode:!1},i.prototype.slice=function(){var t=this.options,e=this.lineXArray,n=this.lineYArray,i=this.width,o=t.middleBoundaryMode,a=e.length,s=n.length;o&&3>s&&(o=!1);var u,f,l,c,p,h,d,g,y=0,m=0,v=0,w=[];if(!s||!a)return this.getChildBlocks();if(!o)return this.getChildBlocks();for(l=0,p=a;p>l;l++){for(u=e[l],m=n[0],d={width:i,height:u-y,x:0,y:0===l?0:y,children:[],boundary:{leftTop:{x:n[0],y:0===l?0:y},rightBottom:{x:n[s-2],y:u}}},w.push(d),c=1,h=s-1;h>c;c++)f=n[c],g={width:f-m,height:u-y,x:m,y:0===l?0:y},r.extend(g,{left:1===c?0:m-n[0],top:0,parentBlockIndex:v,index:c-1}),d.children.push(g),m=f;v++,y=u}return w},i.prototype.getChildBlocks=function(){var t,e,n,i,r,o,a=this.lineXArray,s=this.lineYArray,u=this.width,f=this.height,l=a.length,c=s.length,p=0,h=0,d=[];if(l)for(n=0,r=l;r>n;n++){if(t=a[n],h=0,c)for(i=0,o=c;o>i;i++)e=s[i],d.push({width:e-h,height:t-p,x:h,y:0===n?0:p}),h=e;else d.push({width:u,height:t-p,x:0,y:0===n?0:p});p=t}else for(h=0,i=0,o=c;o>i;i++)e=s[i],d.push({width:e-h,height:f,x:0===n?0:h,y:0}),h=e;return d},e.exports=i},{"./utils":13}],13:[function(t,e,n){"use strict";var i={};i.type=function(t){return Object.prototype.toString.call(t).split(" ")[1].replace("]","")},i.each=function(t,e){var n=t.length;if(n)for(var i=0;n>i&&e.call(t[i],t[i],i)!==!1;i++);else if("undefined"==typeof n)for(var r in t)if(e.call(t[r],t[r],r)===!1)break},i.extend=function(t){i.each(arguments,function(e,n){n>0&&i.each(e,function(e,n){"undefined"!=typeof e&&(t[n]=e)})})},i.sortAndUnique=function(t){var e=[],n={};return i.each(t,function(t){n[t]||(e.push(t),n[t]=!0)}),e.sort(function(t,e){return t-e>0})},e.exports=i},{}]},{},[1]);